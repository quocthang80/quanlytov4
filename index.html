<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªï Khoa h·ªçc t·ª± nhi√™n c√¥ng ngh·ªá</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .nav-btn.active {
            background-color: #DBEAFE; /* blue-100 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 500;
        }
        .nav-link {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            color: #4B5563; /* gray-600 */
        }
        .nav-link:hover {
            color: #1D4ED8; /* blue-700 */
            background-color: #EFF6FF; /* blue-50 */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-500 p-2 rounded-lg">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">T·ªï Khoa h·ªçc t·ª± nhi√™n c√¥ng ngh·ªá</h1>
                        <p class="text-sm text-gray-600">H·ªá th·ªëng l·∫≠p k·∫ø ho·∫°ch v√† qu·∫£n l√Ω ho·∫°t ƒë·ªông</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden">
                        <span class="text-sm text-gray-600">Xin ch√†o, </span>
                        <span id="userName" class="font-medium text-gray-900"></span>
                    </div>
                    <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ƒêƒÉng nh·∫≠p
                    </button>
                    <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-4 py-3 overflow-x-auto">
                <button class="nav-btn active px-4 py-2 rounded-lg font-medium transition-all flex-shrink-0" data-tab="plans">üìÖ K·∫ø ho·∫°ch</button>
                <button class="nav-btn text-gray-600 hover:text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium transition-all flex-shrink-0" data-tab="teaching">üë©‚Äçüè´ Thao gi·∫£ng</button>
                <button class="nav-btn text-gray-600 hover:text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium transition-all flex-shrink-0" data-tab="observation">üëÅÔ∏è D·ª± gi·ªù</button>
                <button class="nav-btn text-gray-600 hover:text-blue-700 hover:bg-blue-50 px-4 py-2 rounded-lg font-medium transition-all flex-shrink-0" data-tab="topics">üìö Chuy√™n ƒë·ªÅ</button>
                
                <a href="https://drive.google.com/drive/folders/17L5Y8aoGn5ttTDyTEZZoXhX0nb4Cv5B2?usp=drive_link" target="_blank" rel="noopener noreferrer" class="nav-link flex-shrink-0">üìù N·ªôp b√†i d·∫°y</a>
                <a href="https//quocthang80.github.io/matrix-new/" target="_blank" rel="noopener noreferrer" class="nav-link flex-shrink-0">üìä Ma tr·∫≠n ƒë·ªÅ</a>
                <a href="https://quocthang80.github.io/qlpthv4/" target="_blank" rel="noopener noreferrer" class="nav-link flex-shrink-0">üî¨ Ph√≤ng th·ª±c h√†nh</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- K·∫ø ho·∫°ch Tab -->
        <div id="plans-tab" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">K·∫ø ho·∫°ch T·ªï</h2>
                    <div class="flex space-x-3">
                        <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" onclick="openModal('plan')">+ Th√™m k·∫ø ho·∫°ch</button>
                    </div>
                </div>
                <div id="plansList" class="space-y-4"></div>
            </div>
        </div>
        
        <!-- Thao gi·∫£ng Tab -->
        <div id="teaching-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">ƒêƒÉng k√Ω Thao gi·∫£ng</h2>
                    <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" onclick="openModal('teaching')">+ ƒêƒÉng k√Ω</button>
                </div>
                <div id="teachingList" class="space-y-4"></div>
            </div>
        </div>

        <!-- D·ª± gi·ªù Tab -->
        <div id="observation-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">ƒêƒÉng k√Ω D·ª± gi·ªù</h2>
                    <button class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" onclick="openModal('observation')">+ ƒêƒÉng k√Ω</button>
                </div>
                <div id="observationList" class="space-y-4"></div>
            </div>
        </div>

        <!-- Chuy√™n ƒë·ªÅ Tab -->
        <div id="topics-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">ƒêƒÉng k√Ω Chuy√™n ƒë·ªÅ</h2>
                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" onclick="openModal('topic')">+ ƒêƒÉng k√Ω</button>
                </div>
                <div id="topicsList" class="space-y-4"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="planModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 id="planModalTitle" class="text-xl font-bold mb-4">Th√™m K·∫ø ho·∫°ch</h3>
            <form id="planForm">
                <input type="hidden" id="planEditId">
                <textarea id="planContent" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4 h-32 resize-y" placeholder="N·ªôi dung k·∫ø ho·∫°ch" required></textarea>
                <input type="date" id="planDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                <input type="url" id="planAttachmentUrl" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="URL ƒë√≠nh k√®m (v√≠ d·ª•: Google Drive link)">
                <div class="flex space-x-3"><button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg">L∆∞u</button><button type="button" onclick="closeModal('plan')" class="flex-1 bg-gray-300 py-2 rounded-lg">H·ªßy</button></div>
            </form>
        </div>
    </div>
    <div id="teachingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 id="teachingModalTitle" class="text-xl font-bold mb-4">ƒêƒÉng k√Ω Thao gi·∫£ng</h3>
            <form id="teachingForm">
                <input type="hidden" id="teachingEditId">
                <input type="text" id="teachingLesson" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="T√™n b√†i d·∫°y" required>
                <input type="text" id="teachingClass" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="L·ªõp" required>
                <input type="date" id="teachingDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                <select id="teachingSession" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                    <option value="">Ch·ªçn bu·ªïi</option>
                    <option value="S√°ng">S√°ng</option>
                    <option value="Chi·ªÅu">Chi·ªÅu</option>
                </select>
                <input type="number" id="teachingPeriod" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="Ti·∫øt" min="1" max="10" required>
                <div class="flex space-x-3"><button type="submit" class="flex-1 bg-green-500 text-white py-2 rounded-lg">L∆∞u</button><button type="button" onclick="closeModal('teaching')" class="flex-1 bg-gray-300 py-2 rounded-lg">H·ªßy</button></div>
            </form>
        </div>
    </div>
    <div id="observationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 id="observationModalTitle" class="text-xl font-bold mb-4">ƒêƒÉng k√Ω D·ª± gi·ªù</h3>
            <form id="observationForm">
                <input type="hidden" id="observationEditId">
                <input type="text" id="observationTeacher" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="Gi√°o vi√™n ƒë∆∞·ª£c d·ª±" required>
                <input type="text" id="observationLesson" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="T√™n b√†i d·∫°y" required>
                <input type="text" id="observationClass" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="L·ªõp" required>
                <input type="date" id="observationDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                <select id="observationSession" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                    <option value="">Ch·ªçn bu·ªïi</option>
                    <option value="S√°ng">S√°ng</option>
                    <option value="Chi·ªÅu">Chi·ªÅu</option>
                </select>
                <input type="number" id="observationPeriod" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="Ti·∫øt" min="1" max="10" required>
                <div class="flex space-x-3"><button type="submit" class="flex-1 bg-purple-500 text-white py-2 rounded-lg">L∆∞u</button><button type="button" onclick="closeModal('observation')" class="flex-1 bg-gray-300 py-2 rounded-lg">H·ªßy</button></div>
            </form>
        </div>
    </div>
    <div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
            <h3 id="topicModalTitle" class="text-xl font-bold mb-4">ƒêƒÉng k√Ω Chuy√™n ƒë·ªÅ</h3>
            <form id="topicForm">
                <input type="hidden" id="topicEditId">
                <input type="text" id="topicName" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" placeholder="T√™n chuy√™n ƒë·ªÅ" required>
                <input type="date" id="topicDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4" required>
                <div class="flex space-x-3"><button type="submit" class="flex-1 bg-yellow-500 text-white py-2 rounded-lg">L∆∞u</button><button type="button" onclick="closeModal('topic')" class="flex-1 bg-gray-300 py-2 rounded-lg">H·ªßy</button></div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqXsGbu4KZd1jwRkyOzlk9eS90UsHDaAE",
            authDomain: "qltokhtncnv1.firebaseapp.com",
            projectId: "qltokhtncnv1",
            storageBucket: "qltokhtncnv1.appspot.com",
            messagingSenderId: "707308620562",
            appId: "1:707308620562:web:ef809afc1c2f1e0c9041cb"
        };
        let db, auth;
        let isFirebaseInitialized = false;

        // NEW: Define the admin email
        const adminEmail = "tiaquocthang.thcspl2@gmail.com"; // THAY ƒê·ªîI EMAIL N√ÄY TH√ÄNH EMAIL QU·∫¢N TR·ªä VI√äN C·ª¶A B·∫†N
        let isAdmin = false;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseInitialized = true;
                setupRealAuthentication();
            } catch (error) {
                console.warn("Firebase initialization failed:", error.message);
                setupDemoMode(); // Fallback to demo mode if Firebase init fails
            }
        });

        // --- AUTHENTICATION & APP MODES ---
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');

        function setupRealAuthentication() {
            // This listener will update the UI whenever the user's sign-in state changes.
            auth.onAuthStateChanged(user => {
                updateUIForUser(user);
            });

            // When the login button is clicked, open the Google sign-in popup.
            loginBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .catch((error) => {
                        // Handle potential errors during login, like the user closing the popup.
                        console.error("L·ªói ƒëƒÉng nh·∫≠p:", error.message);
                    });
            });

            // When the logout button is clicked, sign the user out.
            logoutBtn.addEventListener('click', () => auth.signOut());
        }

        function setupDemoMode() {
            // In a real application, you might want a more robust demo mode or error message
            console.log("Running in demo mode or Firebase not fully initialized. Some features may be limited.");
            // Example: set a dummy user for demo if needed, but for this admin feature,
            // we'll assume no admin privileges in demo mode.
            updateUIForUser(null);
        }

        function updateUIForUser(user) {
            if (user) {
                userInfo.classList.remove('hidden');
                userName.textContent = user.displayName || user.email;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                // NEW: Check if the logged-in user is the admin
                isAdmin = (user.email === adminEmail);
                console.log("Admin status:", isAdmin); // For debugging
                loadAllData();
            } else {
                userInfo.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                isAdmin = false; // Reset admin status on logout
                clearAllData();
            }
        }

        // --- UI & TABS ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(tab => tab.classList.add('hidden'));
                button.classList.add('active');
                document.getElementById(`${button.dataset.tab}-tab`).classList.remove('hidden');
            });
        });

        // --- MODAL & FORM HELPERS ---
        const modals = {
            plan: { el: document.getElementById('planModal'), form: document.getElementById('planForm'), title: document.getElementById('planModalTitle'), defaultTitle: "Th√™m K·∫ø ho·∫°ch" },
            teaching: { el: document.getElementById('teachingModal'), form: document.getElementById('teachingForm'), title: document.getElementById('teachingModalTitle'), defaultTitle: "ƒêƒÉng k√Ω Thao gi·∫£ng" },
            observation: { el: document.getElementById('observationModal'), form: document.getElementById('observationForm'), title: document.getElementById('observationModalTitle'), defaultTitle: "ƒêƒÉng k√Ω D·ª± gi·ªù" },
            topic: { el: document.getElementById('topicModal'), form: document.getElementById('topicForm'), title: document.getElementById('topicModalTitle'), defaultTitle: "ƒêƒÉng k√Ω Chuy√™n ƒë·ªÅ" },
        };
        
        window.openModal = (type, id = null) => {
            const modal = modals[type];
            modal.form.reset();
            const editIdField = modal.form.querySelector('input[type="hidden"]');
            editIdField.value = '';

            if (id) {
                // This is an edit operation
                modal.title.textContent = "Ch·ªânh s·ª≠a " + modal.defaultTitle.replace(/Th√™m |ƒêƒÉng k√Ω /, '').toLowerCase();
                editIdField.value = id;
                // Fetch data and populate form
                // Use plural collection names, with a special case for 'teaching'
                const collectionName = type === 'teaching' ? 'teachings' : type + 's';
                db.collection(collectionName).doc(id).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        switch (type) {
                            case 'plan':
                                document.getElementById('planContent').value = data.content;
                                document.getElementById('planDate').value = data.date;
                                document.getElementById('planAttachmentUrl').value = data.attachmentUrl || '';
                                break;
                            case 'teaching':
                                document.getElementById('teachingLesson').value = data.lesson;
                                document.getElementById('teachingClass').value = data.class;
                                document.getElementById('teachingDate').value = data.date;
                                document.getElementById('teachingSession').value = data.session;
                                document.getElementById('teachingPeriod').value = data.period;
                                break;
                            case 'observation':
                                document.getElementById('observationTeacher').value = data.teacher;
                                document.getElementById('observationLesson').value = data.lesson;
                                document.getElementById('observationClass').value = data.class;
                                document.getElementById('observationDate').value = data.date;
                                document.getElementById('observationSession').value = data.session;
                                document.getElementById('observationPeriod').value = data.period;
                                break;
                            case 'topic':
                                document.getElementById('topicName').value = data.name;
                                document.getElementById('topicDate').value = data.date;
                                break;
                        }
                    }
                });
            } else {
                // This is an add operation
                modal.title.textContent = modal.defaultTitle;
            }
            modal.el.classList.add('flex');
            modal.el.classList.remove('hidden');
        };

        window.closeModal = (type) => {
            modals[type].el.classList.add('hidden');
            modals[type].el.classList.remove('flex');
        };

        // --- FORM SUBMISSION (CREATE & UPDATE) ---
        function handleFormSubmit(e, type) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                // Using a custom message box instead of alert()
                showMessageBox("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y.", "L·ªói");
                return;
            }

            const form = e.target;
            const editId = form.querySelector('input[type="hidden"]').value;
            // Use plural collection names, with a special case for 'teaching'
            const collectionName = type === 'teaching' ? 'teachings' : type + 's';
            let data = {};

            switch (type) {
                case 'plan':
                    data = {
                        content: form.planContent.value,
                        date: form.planDate.value,
                        attachmentUrl: form.planAttachmentUrl.value,
                    };
                    break;
                case 'teaching':
                    data = {
                        lesson: form.teachingLesson.value,
                        class: form.teachingClass.value,
                        date: form.teachingDate.value,
                        session: form.teachingSession.value,
                        period: form.teachingPeriod.value,
                    };
                    break;
                case 'observation':
                    data = {
                        teacher: form.observationTeacher.value,
                        lesson: form.observationLesson.value,
                        class: form.observationClass.value,
                        date: form.observationDate.value,
                        session: form.observationSession.value,
                        period: form.observationPeriod.value,
                    };
                    break;
                case 'topic':
                     data = {
                        name: form.topicName.value,
                        date: form.topicDate.value,
                    };
                    break;
            }

            if (editId) {
                // Update existing document
                db.collection(collectionName).doc(editId).update(data)
                    .then(() => closeModal(type))
                    .catch(error => console.error("Error updating document: ", error));
            } else {
                // Add new document
                data.author = user.displayName || user.email;
                data.authorId = user.uid;
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection(collectionName).add(data)
                    .then(() => closeModal(type))
                    .catch(error => console.error("Error adding document: ", error));
            }
        }

        modals.plan.form.addEventListener('submit', (e) => handleFormSubmit(e, 'plan'));
        modals.teaching.form.addEventListener('submit', (e) => handleFormSubmit(e, 'teaching'));
        modals.observation.form.addEventListener('submit', (e) => handleFormSubmit(e, 'observation'));
        modals.topic.form.addEventListener('submit', (e) => handleFormSubmit(e, 'topic'));

        // --- DELETE FUNCTIONALITY (UPDATED for Admin) ---
        window.deleteItem = (collectionName, id) => {
            // Using a custom message box for confirmation
            showConfirmationBox("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y kh√¥ng?", "X√≥a m·ª•c", () => {
                db.collection(collectionName).doc(id).delete()
                    .then(() => console.log("Document successfully deleted!"))
                    .catch(error => console.error("Error removing document: ", error));
            });
        };

        // --- DATA RENDERING (UPDATED for Admin Controls) ---
        const lists = {
            plans: document.getElementById('plansList'),
            teachings: document.getElementById('teachingList'), // Key changed to plural
            observations: document.getElementById('observationList'),
            topics: document.getElementById('topicsList'),
        };

        function renderList(type, items) { // type is now the plural collection name
            const container = lists[type];
            const collectionName = type;
            container.innerHTML = items.length === 0 ? `<p class="text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>` : '';
            
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center card-hover fade-in'; // Added card-hover and fade-in
                
                let contentHTML = '';
                switch (type) {
                    case 'plans':
                        contentHTML = `<strong>${item.content}</strong> - <span>Ng√†y: ${item.date}</span>`;
                        if (item.attachmentUrl) {
                            contentHTML += ` <a href="${item.attachmentUrl}" target="_blank" class="text-blue-500 hover:underline ml-2">[Xem ƒë√≠nh k√®m]</a>`;
                        }
                        break;
                    case 'teachings': // Case changed to plural
                        contentHTML = `<strong>${item.lesson}</strong> (L·ªõp ${item.class}) - <span>Bu·ªïi ${item.session}, Ti·∫øt ${item.period}, Ng√†y: ${item.date}</span>`;
                        break;
                    case 'observations':
                        contentHTML = `D·ª± gi·ªù GV: <strong>${item.teacher}</strong> - B√†i: <strong>${item.lesson || 'Ch∆∞a c√≥'}</strong> (L·ªõp ${item.class}) - <span>Bu·ªïi ${item.session}, Ti·∫øt ${item.period}, Ng√†y: ${item.date}</span>`;
                        break;
                    case 'topics':
                        contentHTML = `<strong>${item.name}</strong> - <span>Ng√†y: ${item.date}</span>`;
                        break;
                }

                // Determine singular form for the openModal function
                let singularType;
                if (type === 'teachings') {
                    singularType = 'teaching';
                } else {
                    // This works for 'plans', 'observations', 'topics'
                    singularType = type.slice(0, -1);
                }

                const user = auth.currentUser;
                // NEW: Admin can delete any item, author can edit/delete their own
                const canEdit = user && user.uid === item.authorId;
                const canDelete = isAdmin || (user && user.uid === item.authorId);

                let controls = '';
                if (canEdit) {
                    controls += `
                        <button onclick="openModal('${singularType}', '${item.id}')" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                        </button>`;
                }
                if (canDelete) {
                    controls += `
                        <button onclick="deleteItem('${collectionName}', '${item.id}')" class="bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>`;
                }
                
                const controlDiv = controls ? `<div class="flex space-x-2 flex-shrink-0">${controls}</div>` : '';


                el.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-gray-800">${contentHTML}</p>
                        <p class="text-sm text-gray-500">ƒêƒÉng b·ªüi: ${item.author}</p>
                    </div>
                    ${controlDiv}
                `;
                container.appendChild(el);
            });
        }

        // --- DATA LOADING (UPDATED) ---
        function loadAllData() {
            if (!isFirebaseInitialized) return;
            // Use consistent, plural collection names
            const collections = ['plans', 'teachings', 'observations', 'topics'];
            collections.forEach(collectionName => {
                db.collection(collectionName).orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderList(collectionName, items); // Pass the plural collection name directly
                }, error => {
                    console.error(`Error fetching ${collectionName}: `, error);
                });
            });
        }

        function clearAllData() {
            Object.values(lists).forEach(listElement => {
                listElement.innerHTML = `<p class="text-center text-gray-500">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem d·ªØ li·ªáu.</p>`;
            });
        }

        // --- CUSTOM MESSAGE/CONFIRMATION BOX (REPLACEMENT FOR alert/confirm) ---
        function createMessageBox() {
            const messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[9999]';
            messageBox.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-4 fade-in">
                    <h4 id="messageBoxTitle" class="text-xl font-bold mb-4"></h4>
                    <p id="messageBoxContent" class="mb-6"></p>
                    <div class="flex justify-end space-x-3">
                        <button id="messageBoxConfirmBtn" class="hidden bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">X√°c nh·∫≠n</button>
                        <button id="messageBoxCloseBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">ƒê√≥ng</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
            return messageBox;
        }

        let messageBox = document.getElementById('customMessageBox');
        if (!messageBox) {
            messageBox = createMessageBox();
        }

        const messageBoxTitle = messageBox.querySelector('#messageBoxTitle');
        const messageBoxContent = messageBox.querySelector('#messageBoxContent');
        const messageBoxCloseBtn = messageBox.querySelector('#messageBoxCloseBtn');
        const messageBoxConfirmBtn = messageBox.querySelector('#messageBoxConfirmBtn');

        function showMessageBox(message, title = "Th√¥ng b√°o") {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxConfirmBtn.classList.add('hidden');
            messageBoxCloseBtn.onclick = () => messageBox.classList.add('hidden');
            messageBox.classList.remove('hidden');
        }

        function showConfirmationBox(message, title = "X√°c nh·∫≠n", onConfirm) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxConfirmBtn.classList.remove('hidden');
            messageBoxCloseBtn.onclick = () => messageBox.classList.add('hidden');
            messageBoxConfirmBtn.onclick = () => {
                onConfirm();
                messageBox.classList.add('hidden');
            };
            messageBox.classList.remove('hidden');
        }
    </script>
</body>
</html>

